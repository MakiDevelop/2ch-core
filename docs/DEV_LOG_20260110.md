# 2ch.tw é–‹ç™¼æ—¥èªŒ - 2026/01/10

## ğŸ“… é–‹ç™¼ä¿¡æ¯

- **æ—¥æœŸ**: 2026 å¹´ 1 æœˆ 10 æ—¥
- **ç‰ˆæœ¬**: v0.2.0 (é–‹ç™¼ä¸­)
- **åŸºç¤ç‰ˆæœ¬**: v0.1.0
- **é–‹ç™¼éšæ®µ**: P0-P2 å®Œæˆï¼Œå®¹å™¨å„ªåŒ–å®Œæˆ

---

## ğŸ¯ ä»Šæ—¥å®ŒæˆåŠŸèƒ½

### Phase 0 (P0): æ ¸å¿ƒ API å¯¦ç¾ âœ…

#### 1. GET /posts/:id - ç²å–ä¸»é¡Œè©³æƒ…
**æ–‡ä»¶**: `src/agents/persistence/postgres.ts`, `src/agents/api/posts.ts`

**æ–°å¢å‡½æ•¸**:
- `getThreadById(id: number): Promise<ThreadDetail | null>`
  - ä½¿ç”¨ LEFT JOIN çµ±è¨ˆå›å¾©æ•¸
  - è¨ˆç®—æœ€å¾Œå›å¾©æ™‚é–“
  - è¿”å› ThreadDetail é¡å‹ï¼ˆå«çµ±è¨ˆä¿¡æ¯ï¼‰

**API ç‰¹æ€§**:
- åƒæ•¸é©—è­‰ï¼ˆID å¿…é ˆç‚ºæ­£æ•´æ•¸ï¼‰
- 404 è™•ç†ï¼ˆä¸»é¡Œä¸å­˜åœ¨ï¼‰
- è¿”å›å®Œæ•´çµ±è¨ˆä¿¡æ¯

**éŸ¿æ‡‰ç¤ºä¾‹**:
```json
{
  "id": 8,
  "content": "é€™æ˜¯ä¸€å€‹æ¸¬è©¦ä¸»é¡Œ",
  "status": 0,
  "ipHash": "ddf72b6...",
  "createdAt": "2026-01-10T04:47:49.262Z",
  "parentId": null,
  "replyCount": 3,
  "lastReplyAt": "2026-01-10T04:48:34.116Z"
}
```

#### 2. GET /posts/:id/replies - ç²å–å›å¾©åˆ—è¡¨
**æ–°å¢å‡½æ•¸**:
- `getReplies(threadId, limit, offset): Promise<Post[]>`
  - æ”¯æŒåˆ†é æŸ¥è©¢
  - æŒ‰ ID æ­£åºæ’åˆ—ï¼ˆæ™‚é–“é †åºï¼‰
  - éæ¿¾ parent_id = threadId

**API ç‰¹æ€§**:
- åˆ†é æ”¯æŒï¼ˆlimit: 1-100, offset: >=0ï¼‰
- å…ˆé©—è­‰ä¸»é¡Œå­˜åœ¨
- è¿”å›ä¸»é¡Œæ‘˜è¦ + å›å¾©åˆ—è¡¨ + åˆ†é ä¿¡æ¯

**éŸ¿æ‡‰ç¤ºä¾‹**:
```json
{
  "thread": {
    "id": 8,
    "content": "é€™æ˜¯ä¸€å€‹æ¸¬è©¦ä¸»é¡Œ",
    "createdAt": "2026-01-10T04:47:49.262Z",
    "replyCount": 3
  },
  "replies": [
    {"id": 9, "content": "é€™æ˜¯ç¬¬ 1 æ¢å›å¾©", ...},
    {"id": 10, "content": "é€™æ˜¯ç¬¬ 2 æ¢å›å¾©", ...}
  ],
  "pagination": {
    "limit": 50,
    "offset": 0,
    "total": 3
  }
}
```

**æ¸¬è©¦çµæœ**:
- âœ… æ­£å¸¸ç²å–å›å¾©åˆ—è¡¨
- âœ… åˆ†é åŠŸèƒ½æ­£å¸¸
- âœ… ä¸å­˜åœ¨çš„ä¸»é¡Œè¿”å› 404
- âœ… ç„¡æ•ˆçš„ ID è¿”å› 400

---

### Phase 1 (P1): Board ç³»çµ± âœ…

#### 1. æ•¸æ“šåº«è¨­è¨ˆ

**æ–°å¢è¡¨: boards**
```sql
CREATE TABLE boards (
  id SERIAL PRIMARY KEY,
  slug VARCHAR(50) UNIQUE NOT NULL,
  name VARCHAR(100) NOT NULL,
  description TEXT,
  display_order INTEGER DEFAULT 0,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**ä¿®æ”¹è¡¨: posts**
```sql
ALTER TABLE posts ADD COLUMN board_id INTEGER REFERENCES boards(id);
CREATE INDEX idx_posts_board_id ON posts(board_id);
```

**åˆå§‹æ•¸æ“š**: 10 å€‹æ¿å¡Š
1. é›œè«‡ (chat) - é€šç”¨è©±é¡Œå…¥å£
2. æ™‚äº‹ (news) - æ–°èèˆ‡æ”¿æ²»
3. å•å¦ (question) - æå•æ±‚åŠ©
4. æŠ±æ€¨ (rant) - æƒ…ç·’ç™¼æ´©
5. ACG (acg) - å‹•æ¼«éŠæˆ²
6. ç§‘æŠ€ (tech) - ç¨‹å¼èˆ‡ç§‘æŠ€
7. ç”Ÿæ´» (life) - æ—¥å¸¸ç”Ÿæ´»
8. æˆäºº (nsfw) - æˆäººå…§å®¹
9. çˆ­è­° (controversy) - é«˜å°ç«‹è©±é¡Œ
10. å…¶ä»– (other) - æ¸¬è©¦èˆ‡å…¶ä»–

#### 2. Persistence å±¤æ–°å¢

**æ–‡ä»¶**: `src/agents/persistence/postgres.ts`

**æ–°å¢é¡å‹**:
```typescript
export type Board = {
  id: number;
  slug: string;
  name: string;
  description: string | null;
  displayOrder: number;
  isActive: boolean;
  createdAt: Date;
  threadCount?: number;
};
```

**æ–°å¢å‡½æ•¸**:
- `listBoards(): Promise<Board[]>`
  - è¿”å›æ‰€æœ‰æ´»èºæ¿å¡Š
  - çµ±è¨ˆæ¯å€‹æ¿å¡Šçš„ä¸»é¡Œæ•¸
  - æŒ‰ display_order æ’åº

- `getBoardBySlug(slug: string): Promise<Board | null>`
  - æ ¹æ“š slug æŸ¥æ‰¾æ¿å¡Š
  - å«ä¸»é¡Œæ•¸çµ±è¨ˆ

- `getBoardThreads(boardId, limit, offset): Promise<ThreadDetail[]>`
  - ç²å–æ¿å¡Šå…§çš„ä¸»é¡Œåˆ—è¡¨
  - å«å›å¾©çµ±è¨ˆ
  - æŒ‰å‰µå»ºæ™‚é–“å€’åº

**ä¿®æ”¹å‡½æ•¸**:
- `createPost()` - æ–°å¢ `boardId` åƒæ•¸æ”¯æŒ

#### 3. API å±¤å¯¦ç¾

**æ–°å¢æ–‡ä»¶**: `src/agents/api/boards.ts`

**å¯¦ç¾çš„ API**:
1. **GET /boards** - ç²å–æ‰€æœ‰æ¿å¡Š
   - è¿”å›æ¿å¡Šåˆ—è¡¨ï¼ˆå«ä¸»é¡Œæ•¸ï¼‰
   - æŒ‰ display_order æ’åº

2. **GET /boards/:slug/threads** - ç²å–æ¿å¡Šä¸»é¡Œ
   - åˆ†é æ”¯æŒï¼ˆlimit: 1-50, default: 30ï¼‰
   - æ¿å¡Šä¸å­˜åœ¨è¿”å› 404
   - è¿”å›æ¿å¡Šä¿¡æ¯ + ä¸»é¡Œåˆ—è¡¨

3. **POST /boards/:slug/threads** - åœ¨æ¿å¡Šç™¼æ–‡
   - é©—è­‰æ¿å¡Šå­˜åœ¨
   - æ‡‰ç”¨ Guard é˜²è­·
   - è‡ªå‹•è¨­ç½® board_id

**æ¸¬è©¦çµæœ**:
- âœ… æˆåŠŸç²å– 10 å€‹æ¿å¡Š
- âœ… ä¸»é¡Œæ•¸çµ±è¨ˆæº–ç¢º
- âœ… åœ¨ç§‘æŠ€æ¿å‰µå»ºä¸»é¡ŒæˆåŠŸ
- âœ… åœ¨ ACG æ¿å‰µå»ºä¸»é¡ŒæˆåŠŸ
- âœ… ä¸å­˜åœ¨çš„æ¿å¡Šè¿”å› 404

---

### Phase 2 (P2): ç®¡ç†åŠŸèƒ½ âœ…

#### 1. æ¬Šé™ç³»çµ±è¨­è¨ˆ

**å¯¦ç¾æ–¹å¼**: IP Hash ç™½åå–®
- ç’°å¢ƒè®Šé‡: `ADMIN_IP_HASHES` (é€—è™Ÿåˆ†éš”)
- ç„¡éœ€ç”¨æˆ¶ç³»çµ±
- åŸºæ–¼ä¾†æº IP çš„ SHA256 å“ˆå¸Œ

**æ–°å¢æ–‡ä»¶**: `src/agents/guard/adminGuard.ts`

**å¯¦ç¾å‡½æ•¸**:
- `checkIsAdmin(ipHash: string): AdminGuardResult`
  - æª¢æŸ¥ IP Hash æ˜¯å¦åœ¨ç™½åå–®
  - 503: æœªé…ç½®ç®¡ç†å“¡ç³»çµ±
  - 403: éç®¡ç†å“¡è¨ªå•

- `checkDeleteReason(reason?: string): AdminGuardResult`
  - é©—è­‰åˆªé™¤ç†ç”±å¿…å¡«
  - æœ€å¤§ 200 å­—ç¬¦
  - 400: åƒæ•¸éŒ¯èª¤

#### 2. Status ç‹€æ…‹ç³»çµ±

**ç‹€æ…‹å®šç¾©**:
```
status = 0: æ­£å¸¸ï¼ˆå¯è¦‹ã€å¯å›å¾©ï¼‰
status = 1: é–å®šï¼ˆå¯è¦‹ã€ä¸å¯å›å¾©ï¼‰
status = 2: å·²åˆªé™¤ï¼ˆè»Ÿåˆªé™¤ã€ä¸å¯è¦‹ï¼‰
```

#### 3. Persistence å±¤å¯¦ç¾

**æ–°å¢å‡½æ•¸**:
- `deletePost(postId, reason, adminIpHash): Promise<boolean>`
  - è»Ÿåˆªé™¤ï¼ˆstatus = 2ï¼‰
  - è¨˜éŒ„æ“ä½œæ—¥èªŒ

- `lockPost(postId): Promise<boolean>`
  - é–å®šä¸»é¡Œï¼ˆstatus = 1ï¼‰
  - åƒ…å°ä¸»é¡Œæœ‰æ•ˆï¼ˆparent_id IS NULLï¼‰

- `unlockPost(postId): Promise<boolean>`
  - è§£é–ä¸»é¡Œï¼ˆstatus = 0ï¼‰

- `deletePostsByIpHash(ipHash, reason, adminIpHash): Promise<number>`
  - æ‰¹é‡åˆªé™¤ç‰¹å®š IP çš„æ‰€æœ‰å¸–å­
  - è¿”å›å½±éŸ¿çš„è¡Œæ•¸

- `isThreadLocked(threadId): Promise<boolean>`
  - æª¢æŸ¥ä¸»é¡Œæ˜¯å¦é–å®š
  - ç”¨æ–¼å›å¾©æ™‚é©—è­‰

#### 4. API å±¤å¯¦ç¾

**æ–°å¢æ–‡ä»¶**: `src/agents/api/admin.ts`

**å¯¦ç¾çš„ API**:
1. **POST /admin/posts/:id/delete** - åˆªé™¤ä¸»é¡Œæˆ–å›å¾©
   - å¿…éœ€åƒæ•¸: `reason` (åˆªé™¤ç†ç”±)
   - æ¬Šé™æª¢æŸ¥
   - è¨˜éŒ„æ“ä½œæ—¥èªŒ

2. **POST /admin/posts/:id/lock** - é–å®šä¸»é¡Œ
   - ç¦æ­¢æ–°å›å¾©
   - åƒ…å°ä¸»é¡Œæœ‰æ•ˆ

3. **POST /admin/posts/:id/unlock** - è§£é–ä¸»é¡Œ
   - æ¢å¾©å›å¾©åŠŸèƒ½

4. **POST /admin/moderation/by-ip** - æŒ‰ IP æ‰¹é‡æ“ä½œ
   - å¿…éœ€åƒæ•¸: `ipHash`, `action`, `reason`
   - æ”¯æŒæ“ä½œ: `delete_all`
   - è¿”å›å½±éŸ¿çš„å¸–å­æ•¸

**æ“ä½œæ—¥èªŒç¤ºä¾‹**:
```
[ADMIN] Post 14 deleted by ddf72b6...678af4c. Reason: æ¸¬è©¦åˆªé™¤åŠŸèƒ½
[ADMIN] 10 posts from ddf72b6...678af4c deleted by ddf72b6...678af4c. Reason: æ¸¬è©¦æ‰¹é‡åˆªé™¤åŠŸèƒ½
```

**æ¸¬è©¦çµæœ**:
- âœ… åˆªé™¤ä¸»é¡ŒæˆåŠŸï¼ˆstatus: 0 â†’ 2ï¼‰
- âœ… é–å®šä¸»é¡ŒæˆåŠŸï¼ˆstatus: 0 â†’ 1ï¼‰
- âœ… è§£é–ä¸»é¡ŒæˆåŠŸï¼ˆstatus: 1 â†’ 0ï¼‰
- âœ… æ‰¹é‡åˆªé™¤æˆåŠŸï¼ˆ10 å€‹å¸–å­ï¼‰
- âœ… éç®¡ç†å“¡è¨ªå•è¿”å› 403
- âœ… ç¼ºå°‘ reason è¿”å› 400
- âœ… ä¸å­˜åœ¨çš„å¸–å­è¿”å› 404

---

### å®¹å™¨éƒ¨ç½²å„ªåŒ– âœ…

#### 1. Docker Compose å„ªåŒ–

**é–‹ç™¼ç’°å¢ƒ** (`docker-compose.yml`):
```yaml
ç‰¹æ€§:
- å¥åº·æª¢æŸ¥ï¼ˆæ‰€æœ‰æœå‹™ï¼‰
- å„ªåŒ–å•Ÿå‹•ä¾è³´ï¼ˆcondition: service_healthyï¼‰
- ç¨ç«‹ç¶²çµ¡ï¼ˆ2ch-networkï¼‰
- é‡å•Ÿç­–ç•¥ï¼ˆunless-stoppedï¼‰
- æ—¥èªŒè¼ªè½‰ï¼ˆ10MB Ã— 3 æ–‡ä»¶ï¼‰
- node_modules å·ä¿è­·
```

**ç”Ÿç”¢ç’°å¢ƒ** (`docker-compose.prod.yml`):
```yaml
ç‰¹æ€§:
- Dockerfile å¤šéšæ®µæ§‹å»º
- è³‡æºé™åˆ¶ï¼ˆCPU/Memoryï¼‰
- æ›´åš´æ ¼é‡å•Ÿç­–ç•¥ï¼ˆalwaysï¼‰
- Redis å¯†ç¢¼ä¿è­·
- å‚™ä»½å·æ›è¼‰
- æ›´é•·æ—¥èªŒä¿ç•™ï¼ˆ50MB Ã— 5 æ–‡ä»¶ï¼‰
```

#### 2. å¥åº·æª¢æŸ¥é…ç½®

| æœå‹™ | æª¢æŸ¥æ–¹å¼ | é–“éš” | è¶…æ™‚ | é‡è©¦ | å•Ÿå‹•æœŸ |
|------|---------|------|------|------|--------|
| API | wget /health | 10s | 5s | 3 | 30s |
| PostgreSQL | pg_isready | 5s | 3s | 5 | 10s |
| Redis | redis-cli ping | 5s | 3s | 5 | 5s |

**æ•ˆæœ**: API åªåœ¨æ•¸æ“šåº«å’Œ Redis å®Œå…¨å°±ç·’å¾Œæ‰å•Ÿå‹•ã€‚

#### 3. è³‡æºé™åˆ¶ï¼ˆç”Ÿç”¢ç’°å¢ƒï¼‰

| æœå‹™ | CPU é™åˆ¶ | å…§å­˜é™åˆ¶ | CPU é ç•™ | å…§å­˜é ç•™ |
|------|---------|----------|---------|----------|
| API | 1.0 | 512M | 0.25 | 128M |
| PostgreSQL | 1.0 | 1G | 0.5 | 256M |
| Redis | 0.5 | 512M | 0.1 | 128M |

#### 4. æ–°å¢æ–‡ä»¶

**Dockerfile** - å¤šéšæ®µæ§‹å»º:
```dockerfile
Stage 1: Builder
- å®‰è£æ‰€æœ‰ä¾è³´
- æº–å‚™æºä»£ç¢¼

Stage 2: Production
- åƒ…ç”Ÿç”¢ä¾è³´
- é root ç”¨æˆ¶
- å¥åº·æª¢æŸ¥
```

**.dockerignore** - æ§‹å»ºå„ªåŒ–:
- æ’é™¤ node_modules
- æ’é™¤æ–‡æª”å’Œæ¸¬è©¦
- æ’é™¤ç’°å¢ƒè®Šé‡æ–‡ä»¶

**scripts/docker-manage.sh** - ç®¡ç†è…³æœ¬:
```bash
åŠŸèƒ½:
- start/stop/restart: å®¹å™¨ç”Ÿå‘½é€±æœŸ
- logs/status: æŸ¥çœ‹ç‹€æ…‹å’Œæ—¥èªŒ
- shell: é€²å…¥å®¹å™¨
- db-migrate/backup/restore: æ•¸æ“šåº«ç®¡ç†
- health: å¥åº·æª¢æŸ¥
- clean/reset: æ¸…ç†å’Œé‡ç½®
```

**Makefile** - ç°¡æ½”å‘½ä»¤:
```makefile
make start        # å•Ÿå‹•é–‹ç™¼ç’°å¢ƒ
make stop         # åœæ­¢å®¹å™¨
make logs         # æŸ¥çœ‹æ—¥èªŒ
make shell-api    # é€²å…¥ API å®¹å™¨
make backup       # å‚™ä»½æ•¸æ“šåº«
make health       # å¥åº·æª¢æŸ¥
```

**DOCKER.md** - å®Œæ•´æ–‡æª”:
- å¿«é€Ÿé–‹å§‹æŒ‡å—
- ç’°å¢ƒé…ç½®èªªæ˜
- å®¹å™¨ç®¡ç†å‘½ä»¤
- æ•¸æ“šæŒä¹…åŒ–æ–¹æ¡ˆ
- å¥åº·æª¢æŸ¥èªªæ˜
- æ—¥èªŒç®¡ç†é…ç½®
- æ•…éšœæ’æŸ¥æŒ‡å—

#### 5. ç¶²çµ¡é…ç½®

**ç¨ç«‹ç¶²çµ¡**: `2ch-network` (bridge)
```
172.24.0.0/16
â”œâ”€â”€ postgres: 172.24.0.3
â”œâ”€â”€ api:      172.24.0.4
â””â”€â”€ redis:    172.24.0.2
```

**æœå‹™ç™¼ç¾**: é€šéæœå‹™åè‡ªå‹•è§£æ
```
DATABASE_URL: postgres://postgres:postgres@postgres:5432/2ch
REDIS_URL: redis://redis:6379
```

#### 6. æ•¸æ“šæŒä¹…åŒ–

**Docker Volumes**:
- `postgres_data`: PostgreSQL æ•¸æ“š
- `redis_data`: Redis æ•¸æ“š

**å‚™ä»½åŠŸèƒ½**:
```bash
$ make backup
å‚™ä»½å®Œæˆ: ./db/backup/2ch_backup_20260110_130707.sql.gz (2.7KB)
```

**æ¸¬è©¦çµæœ**:
- âœ… æ‰€æœ‰æœå‹™å¥åº·æª¢æŸ¥é€šé
- âœ… å•Ÿå‹•ä¾è³´é †åºæ­£ç¢º
- âœ… ç¶²çµ¡éš”é›¢æ­£å¸¸
- âœ… æ•¸æ“šæŒä¹…åŒ–æœ‰æ•ˆ
- âœ… å‚™ä»½åŠŸèƒ½æ­£å¸¸
- âœ… ç®¡ç†è…³æœ¬å¯ç”¨

---

## ğŸ“Š å®Œæ•´ API æ¸…å–®

### åŸºç¤ API (v0.1)
- âœ… POST /posts - å‰µå»ºä¸»é¡Œæˆ–å›å¾©
- âœ… GET /posts - ç²å–æœ€æ–°ä¸»é¡Œåˆ—è¡¨

### P0 API (ä»Šæ—¥æ–°å¢)
- âœ… GET /posts/:id - ç²å–ä¸»é¡Œè©³æƒ…
- âœ… GET /posts/:id/replies - ç²å–å›å¾©åˆ—è¡¨

### P1 API (ä»Šæ—¥æ–°å¢)
- âœ… GET /boards - ç²å–æ¿å¡Šåˆ—è¡¨
- âœ… GET /boards/:slug/threads - ç²å–æ¿å¡Šä¸»é¡Œ
- âœ… POST /boards/:slug/threads - åœ¨æ¿å¡Šç™¼æ–‡

### P2 API (ä»Šæ—¥æ–°å¢)
- âœ… POST /admin/posts/:id/delete - åˆªé™¤ä¸»é¡Œ/å›å¾©
- âœ… POST /admin/posts/:id/lock - é–å®šä¸»é¡Œ
- âœ… POST /admin/posts/:id/unlock - è§£é–ä¸»é¡Œ
- âœ… POST /admin/moderation/by-ip - æ‰¹é‡æ“ä½œ

**ç¸½è¨ˆ**: 12 å€‹ API ç«¯é»

---

## ğŸ“ ä»Šæ—¥æ–‡ä»¶è®Šæ›´

### æ–°å¢æ–‡ä»¶

```
src/agents/api/
â”œâ”€â”€ boards.ts                    # Board API è™•ç†å™¨
â””â”€â”€ admin.ts                     # ç®¡ç† API è™•ç†å™¨

src/agents/guard/
â””â”€â”€ adminGuard.ts                # ç®¡ç†å“¡æ¬Šé™æª¢æŸ¥

db/
â”œâ”€â”€ migrations/
â”‚   â””â”€â”€ 001_add_boards.sql      # Board ç³»çµ±é·ç§»
â”œâ”€â”€ migrate.ts                   # é·ç§»å·¥å…·
â””â”€â”€ backup/                      # å‚™ä»½ç›®éŒ„

scripts/
â””â”€â”€ docker-manage.sh             # å®¹å™¨ç®¡ç†è…³æœ¬

docs/
â””â”€â”€ DEV_LOG_20260110.md         # æœ¬é–‹ç™¼æ—¥èªŒ

Dockerfile                       # ç”Ÿç”¢ç’°å¢ƒæ§‹å»º
.dockerignore                    # æ§‹å»ºå„ªåŒ–
Makefile                         # ç°¡æ½”å‘½ä»¤
DOCKER.md                        # å®¹å™¨éƒ¨ç½²æ–‡æª”
```

### ä¿®æ”¹æ–‡ä»¶

```
docker-compose.yml               # é–‹ç™¼ç’°å¢ƒå„ªåŒ–
docker-compose.prod.yml          # ç”Ÿç”¢ç’°å¢ƒé…ç½®
.env                             # æ–°å¢ ADMIN_IP_HASHES
.env.example                     # æ›´æ–°ç¤ºä¾‹

package.json                     # æ–°å¢ scripts

src/agents/persistence/postgres.ts
â”œâ”€â”€ æ–°å¢é¡å‹: Board, ThreadDetail
â”œâ”€â”€ ä¿®æ”¹: createPost (æ”¯æŒ board_id)
â”œâ”€â”€ æ–°å¢: getThreadById
â”œâ”€â”€ æ–°å¢: getReplies
â”œâ”€â”€ æ–°å¢: listBoards
â”œâ”€â”€ æ–°å¢: getBoardBySlug
â”œâ”€â”€ æ–°å¢: getBoardThreads
â”œâ”€â”€ æ–°å¢: deletePost
â”œâ”€â”€ æ–°å¢: lockPost
â”œâ”€â”€ æ–°å¢: unlockPost
â”œâ”€â”€ æ–°å¢: deletePostsByIpHash
â””â”€â”€ æ–°å¢: isThreadLocked

src/agents/api/posts.ts
â”œâ”€â”€ æ–°å¢: getThreadHandler
â””â”€â”€ æ–°å¢: getRepliesHandler

src/agents/api/index.ts
â”œâ”€â”€ å°å‡º Board handlers
â””â”€â”€ å°å‡º Admin handlers

src/agents/guard/index.ts
â””â”€â”€ å°å‡º adminGuard

src/main.ts
â”œâ”€â”€ è¨»å†Š Board è·¯ç”±
â””â”€â”€ è¨»å†Š Admin è·¯ç”±
```

---

## ğŸ—„ï¸ æ•¸æ“šåº«æ¶æ§‹

### ç•¶å‰ Schema

#### posts è¡¨
```sql
id              SERIAL PRIMARY KEY
content         TEXT NOT NULL
status          INTEGER DEFAULT 0
ip_hash         VARCHAR(64) NOT NULL
parent_id       INTEGER REFERENCES posts(id)
board_id        INTEGER REFERENCES boards(id)    -- æ–°å¢
created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP

-- ç´¢å¼•
idx_posts_board_id
idx_posts_created_at_desc
```

#### boards è¡¨ (æ–°å¢)
```sql
id              SERIAL PRIMARY KEY
slug            VARCHAR(50) UNIQUE NOT NULL
name            VARCHAR(100) NOT NULL
description     TEXT
display_order   INTEGER DEFAULT 0
is_active       BOOLEAN DEFAULT true
created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP

-- ç´¢å¼•
idx_boards_slug
idx_boards_display_order
```

**æ•¸æ“šé—œä¿‚**:
- posts.board_id â†’ boards.id (å¤šå°ä¸€)
- posts.parent_id â†’ posts.id (è‡ªé—œè¯ï¼Œå–®å±¤)

---

## ğŸ§ª æ¸¬è©¦è¦†è“‹

### P0 API æ¸¬è©¦
- âœ… ç²å–ä¸»é¡Œè©³æƒ…ï¼ˆå«çµ±è¨ˆï¼‰
- âœ… ç²å–å›å¾©åˆ—è¡¨ï¼ˆåˆ†é ï¼‰
- âœ… ä¸å­˜åœ¨çš„ä¸»é¡Œ 404
- âœ… ç„¡æ•ˆ ID 400
- âœ… åˆ†é åƒæ•¸é©—è­‰

### P1 API æ¸¬è©¦
- âœ… ç²å–æ‰€æœ‰æ¿å¡Š
- âœ… ä¸»é¡Œæ•¸çµ±è¨ˆæº–ç¢º
- âœ… åœ¨ä¸åŒæ¿å¡Šç™¼æ–‡
- âœ… ç²å–æ¿å¡Šä¸»é¡Œåˆ—è¡¨
- âœ… ä¸å­˜åœ¨çš„æ¿å¡Š 404

### P2 API æ¸¬è©¦
- âœ… åˆªé™¤ä¸»é¡Œï¼ˆstatus è®ŠåŒ–ï¼‰
- âœ… é–å®š/è§£é–ä¸»é¡Œ
- âœ… æ‰¹é‡åˆªé™¤ï¼ˆ10 å€‹å¸–å­ï¼‰
- âœ… æ¬Šé™é©—è­‰ï¼ˆ403ï¼‰
- âœ… åƒæ•¸é©—è­‰ï¼ˆ400ï¼‰
- âœ… æ“ä½œæ—¥èªŒè¨˜éŒ„

### å®¹å™¨æ¸¬è©¦
- âœ… å¥åº·æª¢æŸ¥ï¼ˆæ‰€æœ‰æœå‹™ healthyï¼‰
- âœ… å•Ÿå‹•ä¾è³´é †åº
- âœ… ç¶²çµ¡é€£é€šæ€§
- âœ… æ•¸æ“šæŒä¹…åŒ–
- âœ… å‚™ä»½èˆ‡æ¢å¾©
- âœ… è³‡æºé™åˆ¶

---

## ğŸ“ˆ é …ç›®çµ±è¨ˆ

### ä»£ç¢¼çµ±è¨ˆ
- TypeScript æ–‡ä»¶: 12 å€‹
- ç¸½ä»£ç¢¼è¡Œæ•¸: ~1500 è¡Œ
- API ç«¯é»: 12 å€‹
- æ•¸æ“šè¡¨: 2 å€‹
- Docker æœå‹™: 3 å€‹

### åŠŸèƒ½å®Œæˆåº¦
- âœ… P0 (æ ¸å¿ƒ API): 100%
- âœ… P1 (Board ç³»çµ±): 100%
- âœ… P2 (ç®¡ç†åŠŸèƒ½): 100%
- âœ… å®¹å™¨å„ªåŒ–: 100%
- â³ P3 (æœç´¢çµ±è¨ˆ): 0%
- â³ v1.0 (å¯¦æ™‚åŠŸèƒ½): 0%

---

## ğŸ”§ æŠ€è¡“æ£§

### æ ¸å¿ƒæŠ€è¡“
- **é‹è¡Œæ™‚**: Node.js 20 (Alpine)
- **èªè¨€**: TypeScript
- **æ¡†æ¶**: Express 5.x
- **æ•¸æ“šåº«**: PostgreSQL 16 (Alpine)
- **ç·©å­˜**: Redis 7 (Alpine)
- **å®¹å™¨**: Docker Compose

### ä¾è³´åŒ…
```json
{
  "dependencies": {
    "body-parser": "^2.2.1",
    "dotenv": "^17.2.3",
    "express": "^5.2.1",
    "pg": "^8.16.3"
  },
  "devDependencies": {
    "@types/body-parser": "^1.19.6",
    "@types/express": "^5.0.6",
    "@types/pg": "^8.16.0",
    "tsx": "^4.21.0"
  }
}
```

---

## ğŸ¨ è¨­è¨ˆæ¨¡å¼

### ç•¶å‰æ‡‰ç”¨
1. **åˆ†å±¤æ¶æ§‹**
   - API å±¤: è·¯ç”±èˆ‡è«‹æ±‚è™•ç†
   - Guard å±¤: é©—è­‰èˆ‡é˜²è­·
   - Persistence å±¤: æ•¸æ“šè¨ªå•
   - Domain å±¤: æ¥­å‹™é‚è¼¯ï¼ˆé ç•™ï¼‰

2. **å®ˆè¡›æ¨¡å¼** (Guard Pattern)
   - postGuard: å…§å®¹é©—è­‰ã€Rate Limit
   - adminGuard: æ¬Šé™æª¢æŸ¥ã€åƒæ•¸é©—è­‰

3. **è»Ÿåˆªé™¤æ¨¡å¼**
   - ä½¿ç”¨ status å­—æ®µæ¨™è¨˜ç‹€æ…‹
   - ä¿ç•™æ•¸æ“šç”¨æ–¼å¯©è¨ˆ

### æœªä¾†è¦åŠƒ
- **ç­–ç•¥æ¨¡å¼** (Strategy): ä¸åŒæ¿å¡Šçš„è¦å‰‡
- **å·¥å» æ¨¡å¼** (Factory): æ ¹æ“šæƒ…å¢ƒé¸æ“‡å¯¦ç¾
- **è§€å¯Ÿè€…æ¨¡å¼** (Observer): äº‹ä»¶é©…å‹•èˆ‡å³æ™‚æ¨é€

---

## ğŸš€ éƒ¨ç½²èªªæ˜

### é–‹ç™¼ç’°å¢ƒå•Ÿå‹•

```bash
# æ–¹å¼ 1: Makefile (æ¨è–¦)
make start

# æ–¹å¼ 2: ç®¡ç†è…³æœ¬
./scripts/docker-manage.sh start

# æ–¹å¼ 3: Docker Compose
docker compose up -d
```

### å¥åº·æª¢æŸ¥

```bash
make health

# è¼¸å‡º:
# âœ“ API æœå‹™æ­£å¸¸
# âœ“ PostgreSQL æ­£å¸¸
# âœ“ Redis æ­£å¸¸
```

### æ•¸æ“šåº«ç®¡ç†

```bash
# å‚™ä»½
make backup

# æ¢å¾©
make restore FILE=./db/backup/backup.sql.gz

# é‹è¡Œé·ç§»
make migrate
```

---

## ğŸ”’ å®‰å…¨é…ç½®

### ç’°å¢ƒè®Šé‡
```bash
# å¿…éœ€é…ç½®
POSTGRES_PASSWORD=strong_random_password
ADMIN_IP_HASHES=your_ip_hash_here

# ç”Ÿç”¢ç’°å¢ƒé¡å¤–é…ç½®
REDIS_PASSWORD=another_strong_password
```

### IP Hash ç²å–æ–¹å¼
```bash
# 1. å‰µå»ºä¸€å€‹æ¸¬è©¦å¸–å­
curl -X POST http://localhost:3000/posts -d '{"content":"test"}'

# 2. å¾éŸ¿æ‡‰ä¸­ç²å– ipHash
# 3. å°‡ ipHash æ·»åŠ åˆ° .env çš„ ADMIN_IP_HASHES
```

### æ¬Šé™é©—è­‰
- ç®¡ç† API åƒ…å…è¨±ç™½åå–® IP è¨ªå•
- æ‰€æœ‰æ“ä½œè¨˜éŒ„åˆ°æ—¥èªŒ
- éç®¡ç†å“¡è¨ªå•è¿”å› 403

---

## ğŸ“ æœªå®ŒæˆåŠŸèƒ½

### P3 - æœç´¢èˆ‡çµ±è¨ˆ (è¦åŠƒä¸­)
- [ ] GET /search - é—œéµè©æœç´¢
- [ ] GET /stats - çµ±è¨ˆæ•¸æ“š
- [ ] æ’åºåŠŸèƒ½ï¼ˆç†±é–€/æœ€æ–°/å›å¾©æ•¸ï¼‰

### v1.0 - å¯¦æ™‚åŠŸèƒ½ (è¦åŠƒä¸­)
- [ ] SSE å¯¦æ™‚æ¨é€æ–°ä¸»é¡Œ/å›å¾©
- [ ] Redis ç·©å­˜ç†±é–€å…§å®¹
- [ ] WebSocket æ”¯æŒ

### å‰ç«¯é–‹ç™¼ (æœªé–‹å§‹)
- [ ] Web ç•Œé¢
- [ ] æ¿å¡Šç€è¦½é é¢
- [ ] ä¸»é¡Œèˆ‡å›å¾©å±•ç¤º

### ç”Ÿç”¢éƒ¨ç½² (æœªé–‹å§‹)
- [ ] Nginx åå‘ä»£ç†é…ç½®
- [ ] SSL/TLS è­‰æ›¸
- [ ] åŸŸåè§£æ
- [ ] CI/CD æµç¨‹

---

## ğŸ› å·²çŸ¥å•é¡Œ

### é™åˆ¶
1. **Rate Limit**: åƒ…å–®é€²ç¨‹å…§å­˜ï¼Œå¤šé€²ç¨‹éœ€è¦ Redis
2. **å…§å®¹éæ¿¾**: ç„¡é»‘åå–®ã€NLP éæ¿¾
3. **è¡Œç‚ºåˆ†æ**: ç„¡ç•°å¸¸æ¨¡å¼æª¢æ¸¬
4. **æœç´¢åŠŸèƒ½**: å°šæœªå¯¦ç¾

### å„ªåŒ–ç©ºé–“
1. **æ•¸æ“šåº«ç´¢å¼•**: å¯ä»¥é‡å°æŸ¥è©¢æ¨¡å¼å„ªåŒ–
2. **ç·©å­˜ç­–ç•¥**: ç†±é–€æ¿å¡Šå¯ä»¥ Redis ç·©å­˜
3. **æŸ¥è©¢å„ªåŒ–**: çµ±è¨ˆæŸ¥è©¢å¯ä»¥å„ªåŒ– SQL

---

## ğŸ’¡ é–‹ç™¼ç¶“é©—ç¸½çµ

### æˆåŠŸç¶“é©—
1. **å…ˆå¯¦ç¾æ ¸å¿ƒåŠŸèƒ½**: P0 â†’ P1 â†’ P2 å¾ªåºæ¼¸é€²
2. **æ¸¬è©¦é©…å‹•**: æ¯å€‹ API å¯¦ç¾å¾Œç«‹å³æ¸¬è©¦
3. **æ–‡æª”åŒæ­¥**: é‚Šé–‹ç™¼é‚Šå®Œå–„æ–‡æª”
4. **å®¹å™¨åŒ–å„ªå…ˆ**: å¾é–‹ç™¼éšæ®µå°±ä½¿ç”¨å®¹å™¨

### æŠ€è¡“äº®é»
1. **å¥åº·æª¢æŸ¥**: ä¾è³´æ¢ä»¶å•Ÿå‹•ï¼Œé¿å…ç«¶æ…‹
2. **è»Ÿåˆªé™¤**: ä¿ç•™æ•¸æ“šç”¨æ–¼å¯©è¨ˆ
3. **IP Hash**: ç„¡éœ€ç”¨æˆ¶ç³»çµ±çš„ç®¡ç†æ–¹æ¡ˆ
4. **åˆ†å±¤æ¸…æ™°**: API/Guard/Persistence è·è²¬æ˜ç¢º

### å¯æ”¹é€²ä¹‹è™•
1. **é¡å‹ç³»çµ±**: å¯ä»¥æ›´åš´æ ¼çš„ TypeScript é…ç½®
2. **éŒ¯èª¤è™•ç†**: å¯ä»¥çµ±ä¸€çš„éŒ¯èª¤è™•ç†ä¸­é–“ä»¶
3. **æ¸¬è©¦è¦†è“‹**: å¯ä»¥å¢åŠ å–®å…ƒæ¸¬è©¦
4. **æ—¥èªŒç³»çµ±**: å¯ä»¥çµæ§‹åŒ–æ—¥èªŒ

---

## ğŸ”— ç›¸é—œæ–‡æª”

- [README.md](../README.md) - é …ç›®æ¦‚è¦½
- [ARCHITECTURE.md](../ARCHITECTURE.md) - æ¶æ§‹è¨­è¨ˆ
- [CHANGELOG.md](../CHANGELOG.md) - ç‰ˆæœ¬æ­·å²
- [DOCKER.md](../DOCKER.md) - å®¹å™¨éƒ¨ç½²æŒ‡å—

---

## ğŸ‘¥ å¾ŒçºŒ AI Agents æ³¨æ„äº‹é …

### é …ç›®ç‰¹æ€§
1. **2ch é¢¨æ ¼**: å–®å±¤å›å¾©ã€ç·šæ€§çµæ§‹ã€é‡æ–‡åŒ–è€Œéçµæ§‹
2. **åŒ¿åç³»çµ±**: åŸºæ–¼ IP Hashï¼Œç„¡ç”¨æˆ¶è¨»å†Š
3. **é˜²æ¿«ç”¨**: Guard å±¤çµ±ä¸€é©—è­‰ï¼Œ10 ç§’ Rate Limit
4. **è»Ÿåˆªé™¤**: status å­—æ®µæ¨™è¨˜ï¼Œä¸å¯¦éš›åˆªé™¤æ•¸æ“š

### ä»£ç¢¼ç´„å®š
1. **å‘½åé¢¨æ ¼**: camelCase (TypeScript), snake_case (SQL)
2. **æ–‡ä»¶çµ„ç¹”**: agents/{api,guard,persistence,domain,realtime}
3. **é¡å‹å®šç¾©**: å„ªå…ˆä½¿ç”¨ TypeScript é¡å‹
4. **éŒ¯èª¤è™•ç†**: try-catch + çµ±ä¸€ JSON éŸ¿æ‡‰

### é–‹ç™¼æµç¨‹
1. **å…ˆè®€æ–‡æª”**: README â†’ ARCHITECTURE â†’ æœ¬æ—¥èªŒ
2. **ç†è§£è¨­è¨ˆ**: 2ch å“²å­¸ â†’ åˆ†å±¤æ¶æ§‹ â†’ API è¨­è¨ˆ
3. **æ¸¬è©¦å„ªå…ˆ**: å¯¦ç¾åŠŸèƒ½ â†’ å¯«æ¸¬è©¦ â†’ é©—è­‰
4. **æ›´æ–°æ–‡æª”**: ä»£ç¢¼è®Šæ›´ â†’ æ›´æ–° CHANGELOG â†’ æ›´æ–°æ—¥èªŒ

### ç¦æ­¢äº‹é …
1. âŒ **ä¸è¦ç ´å£å–®å±¤å›å¾©**: reply çš„ reply ä¸æ”¯æŒ
2. âŒ **ä¸è¦æ·»åŠ ç”¨æˆ¶ç³»çµ±**: ä¿æŒåŒ¿åç‰¹æ€§
3. âŒ **ä¸è¦éåº¦è¨­è¨ˆ**: ç°¡å–®è€ç”¨å„ªå…ˆ
4. âŒ **ä¸è¦è·³é Guard**: æ‰€æœ‰è¼¸å…¥å¿…é ˆé©—è­‰

### å„ªå…ˆç´š
1. **ç©©å®šæ€§** > æ–°åŠŸèƒ½
2. **ç°¡å–®** > è¤‡é›œ
3. **æ€§èƒ½** > ç¾è§€
4. **å¯ç¶­è­·** > ç‚«æŠ€

---

## ğŸ“ è¯ç¹«æ–¹å¼

å¦‚æœ‰å•é¡Œï¼Œè«‹åƒè€ƒï¼š
- GitHub Issues: (å¾…å»ºç«‹)
- é …ç›®æ–‡æª”: `docs/` ç›®éŒ„
- æ¶æ§‹è¨­è¨ˆ: `ARCHITECTURE.md`

---

**é–‹ç™¼è€…**: Claude (Anthropic)
**å”ä½œè€…**: Maki
**æ—¥æœŸ**: 2026-01-10
**ç‰ˆæœ¬**: v0.2.0-dev

---

_æœ¬æ—¥èªŒè¨˜éŒ„å®Œæ•´ï¼Œå¾ŒçºŒ AI Agents å¯åŸºæ–¼æ­¤ç¹¼çºŒé–‹ç™¼ã€‚_
