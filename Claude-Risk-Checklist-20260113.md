# 2ch.tw 內部資安檢視報告

**檢視日期**：2026-01-13
**檢視範圍**：系統設計、資料保護、管理機制、事件回應能力
**檢視立場**：可營運風險控管（非最安全，而是活得久）
**檢視角色**：公司內部資安負責人（Blue Team / AppSec Lead）

---

## 一、現行設計的風險點

### 🔴 不可接受風險（建議立即修正）

#### 1. **管理行為無法追蹤與稽核**

**問題描述**：
- 管理員刪除、鎖定、批量刪除等操作，只有 `console.log` 記錄
- 無法回答「誰在什麼時候刪了什麼」
- 發生爭議或法律請求時，無證據鏈

**風險等級**：**高**
**影響**：
- 無法證明「已盡合理管理責任」
- 管理員濫權無法追查
- 法律請求來時可能被認定「管理不善」

**建議**：
```sql
-- 新增管理日誌表
CREATE TABLE moderation_logs (
  id SERIAL PRIMARY KEY,
  action VARCHAR(50) NOT NULL,        -- delete/lock/unlock/ban_ip
  target_type VARCHAR(20) NOT NULL,   -- post/thread/ip_hash
  target_id VARCHAR(100) NOT NULL,    -- post_id 或 ip_hash
  admin_ip_hash VARCHAR(64) NOT NULL,
  reason TEXT,
  metadata JSONB,                     -- 其他資訊（如受影響筆數）
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_mod_logs_admin ON moderation_logs(admin_ip_hash);
CREATE INDEX idx_mod_logs_target ON moderation_logs(target_type, target_id);
CREATE INDEX idx_mod_logs_created ON moderation_logs(created_at DESC);
```

**實作優先級**：🔥 **P0 - 上線前必須完成**

---

#### 2. **真實 IP 與 User-Agent 無保存期限**

**問題描述**：
- `real_ip` 和 `user_agent` 無限期保存
- 違反資料最小化原則
- 潛在 GDPR / PDPA 風險（若有跨境用戶）

**風險等級**：**中高**
**影響**：
- 若發生資料外洩，影響範圍無限擴大
- 可能被認定「過度收集且保留」
- 難以證明「僅用於必要目的」

**建議**：
```typescript
// 定期清理腳本（建議每週執行）
async function cleanupOldIpData() {
  const RETENTION_DAYS = 90; // 建議 90 天

  const result = await pool.query(
    `UPDATE posts
     SET real_ip = NULL, user_agent = NULL
     WHERE created_at < NOW() - INTERVAL '${RETENTION_DAYS} days'
       AND real_ip IS NOT NULL
     RETURNING id`,
  );

  console.log(`[CLEANUP] Anonymized ${result.rowCount} old posts`);
}
```

**保存期限建議**：
- **90 天**：可應對大部分法律請求與濫用調查
- 超過 90 天的 post 將 `real_ip` 和 `user_agent` 設為 NULL
- 保留 `ip_hash`（用於前台顯示，無法反查）

**實作優先級**：🟡 **P1 - 營運穩定後 30 天內完成**

---

#### 3. **管理員權限無分級與變更記錄**

**問題描述**：
- 所有管理員權限相同（刪文、鎖定、批量刪除）
- 新增/移除管理員需手動改 `.env` 並重啟服務
- 無法追蹤「管理員權限異動」

**風險等級**：**中**
**影響**：
- 離職員工若未及時移除，可能濫權
- 無法證明「誰有權限、何時授予、何時撤銷」

**建議**：
- **短期**（可營運）：定期稽核 `ADMIN_IP_HASHES` 環境變數
- **長期**（更安全）：建立管理員表（不需要帳號系統）

```sql
-- 管理員白名單表
CREATE TABLE admin_whitelist (
  id SERIAL PRIMARY KEY,
  ip_hash VARCHAR(64) UNIQUE NOT NULL,
  role VARCHAR(20) DEFAULT 'moderator',  -- moderator/admin
  granted_by VARCHAR(64),                -- 由誰授予
  granted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  revoked_at TIMESTAMP,
  notes TEXT
);
```

**實作優先級**：🟢 **P2 - 可於營運 3 個月後評估**

---

### 🟡 可接受風險（建議記錄與監控）

#### 4. **IP-based 限流是 in-memory，重啟會重置**

**問題描述**：
- 發文限流（10秒）儲存在記憶體中
- API 重啟後限流重置
- 使用 Proxy/VPN 可繞過

**風險等級**：**低中**
**影響**：
- 重啟後短時間內可能被洗版
- 有動機的攻擊者可透過 IP 輪替繞過

**可接受理由**：
- 這是「最低限度防禦」，不是防 DDoS
- 重啟頻率不高（正常營運下）
- 若真的被洗版，管理員可批量刪除

**建議補強（選擇性）**：
- 短期：記錄重啟時間，觀察是否有異常流量
- 長期：若出現洗版問題，改用 Redis 儲存限流狀態

**實作優先級**：🔵 **P3 - 觀察後決定**

---

#### 5. **管理員認證僅依賴 IP Hash**

**問題描述**：
- IP 變動（網路切換、動態 IP）會失去管理權限
- 理論上可能有 hash 碰撞（機率極低）

**風險等級**：**低**
**影響**：
- 管理員 IP 變動需要更新設定
- 碰撞機率：SHA-256 幾乎不可能

**可接受理由**：
- 符合「不引入帳號系統」原則
- 實務上 IP 不常變（固網、VPN）
- 碰撞機率可忽略（2^256）

**建議補強**：
- 在內部文件註明：管理員應使用固定 IP（如辦公室/VPN）
- 若 IP 變動，需通知技術負責人更新設定

**實作優先級**：📝 **文件化即可**

---

#### 6. **軟刪除後內容仍存在資料庫**

**問題描述**：
- 刪除的 post（status = 2）仍保留完整內容
- 若資料庫被攻擊者取得，可看到所有被刪內容

**風險等級**：**低中**
**影響**：
- 違法內容被刪後仍存在
- 若被要求「永久移除」，現行設計做不到

**可接受理由**：
- 軟刪除是標準做法（可恢復誤刪）
- 資料庫若被攻擊，整個系統已淪陷

**建議補強**：
```typescript
// 新增硬刪除功能（僅限緊急情況）
export async function permanentlyDeletePost(postId: number, adminIpHash: string) {
  // 記錄到 audit log
  await pool.query(
    `INSERT INTO moderation_logs (action, target_type, target_id, admin_ip_hash, reason)
     VALUES ('permanent_delete', 'post', $1, $2, 'Legal requirement / Emergency')`,
    [postId.toString(), adminIpHash]
  );

  // 真正刪除
  const result = await pool.query(`DELETE FROM posts WHERE id = $1 RETURNING id`, [postId]);

  return result.rowCount && result.rowCount > 0;
}
```

**實作優先級**：🟢 **P2 - 可預先準備，需要時啟用**

---

## 二、事件回應能力評估

### ✅ 現有能力

| 情境 | 現有機制 | 是否足夠 |
|------|---------|---------|
| 違法內容舉報 | 管理員可刪除單則 post | ✅ 是 |
| 特定用戶洗版 | 可按 IP Hash 批量刪除 | ✅ 是 |
| 法院要求提供 IP | 可查詢 `real_ip` | ✅ 是 |
| 證明「已刪除違法內容」 | ❌ 無 audit log | ❌ **否** |
| 證明「特定管理員的操作記錄」 | ❌ 只有 console.log | ❌ **否** |
| 回應「何時刪除、刪除原因」 | ❌ 無結構化記錄 | ❌ **否** |

### 🔧 建議 SOP

#### **情境一：收到違法內容舉報**

1. 管理員立即軟刪除（status = 2）
2. 記錄到 moderation_log（含原因）
3. 若涉及嚴重違法（如兒少、恐怖主義）：
   - 保留該 post 的 `real_ip` 和 `user_agent`（不受 90 天限制）
   - 標記為「法律保留」
   - 通知技術負責人

#### **情境二：法院／檢警要求提供資料**

1. 確認公文真實性
2. 提供「最小必要範圍」：
   - Post ID、內容、IP Hash、真實 IP、User-Agent、時間戳
   - **不提供** IP Hash 以外的其他用戶資料
3. 記錄到「法律請求日誌」

#### **情境三：大規模洗版攻擊**

1. 使用「按 IP Hash 批量刪除」
2. 若仍無效，臨時調整限流參數（10 秒 → 60 秒）
3. 紀錄攻擊時間、IP Hash 清單、處理方式

---

## 三、平台責任邊界

### ✅ 平台已承擔的責任

1. **內容審查**：管理員可刪除違法／違規內容
2. **協助調查**：保留 IP 與 User-Agent，可配合法律請求
3. **明確版規**：已在首頁公告禁止內容

### ⚠️ 應明確寫進使用條款的責任邊界

建議新增「**使用者條款與免責聲明**」（`/terms.html`）：

```markdown
## 2ch.tw 使用條款

### 一、服務性質
2ch.tw 是一個由使用者自主發文的匿名討論平台（User-Generated Content, UGC）。
平台不對使用者發表的內容進行事前審查。

### 二、使用者責任
1. 使用者對自己發表的內容負完全責任
2. 使用者不得發表違反台灣法律的內容
3. 使用者發表內容即表示同意平台記錄其 IP 位址與裝置資訊

### 三、平台責任範圍
1. 平台提供「合理管理」，包括刪除明顯違法內容
2. 平台不保證能即時發現或處理所有違規內容
3. 平台保留刪除任何內容的權利，無需說明理由
4. 平台保留配合法律機構調查的權利

### 四、資料收集與保存
1. 平台會記錄發文者的 IP 位址與裝置資訊（User-Agent）
2. 此資料僅用於平台管理與法律調查
3. 此資料將於 90 天後自動刪除（涉及法律調查者除外）
4. 平台不會主動公開此資料

### 五、免責聲明
1. 平台對使用者發表的內容不承擔責任
2. 使用者因發表內容產生的法律問題，由使用者自行承擔
3. 平台不保證服務不中斷、不出錯
```

**實作優先級**：🔥 **P0 - 上線前必須完成**

---

## 四、最低限度內控建議

### 📋 制度面（不影響匿名精神）

#### 1. **管理員操作指引**（內部文件）

```markdown
# 2ch.tw 管理員操作指引

## 何時可以刪除內容？
✅ 明顯違法（參考版規第二條）
✅ 洗版、惡意攻擊
✅ Doxxing（公開他人個資）
✅ 兒少不當內容

⚠️ 灰色地帶（需謹慎判斷）
- 強烈批評但未違法
- 爭議性言論但有討論空間
- 單純「不喜歡」的內容

❌ 不應刪除
- 批評平台或管理員
- 不同政治立場的言論
- 你個人不認同但合法的內容

## 刪除時必須記錄
- 被刪 Post ID
- 刪除原因（簡短即可）
- 違反哪一條版規

## 緊急情況聯絡
- 涉及兒少／暴力／緊急危險：立即通知技術負責人
- 收到法律文件：不要自行處理，轉交法務或負責人
```

#### 2. **定期稽核清單**（每月執行）

```markdown
# 2ch.tw 每月安全稽核

□ 檢查管理員清單（ADMIN_IP_HASHES）是否有離職人員
□ 檢視 moderation_logs，確認無異常操作
□ 檢視系統日誌，確認無異常流量
□ 檢查資料庫空間使用量
□ 確認 IP/UA 清理腳本正常執行（若已實作）
□ 檢視近期被刪內容，確認符合版規

執行人：________________
執行日期：______________
```

#### 3. **事件回應 Runbook**（緊急情況）

```markdown
# 緊急事件回應 Runbook

## 情境 A：收到違法內容舉報
1. [ ] 確認內容確實違法（參考版規）
2. [ ] 軟刪除該 post
3. [ ] 記錄原因與 Post ID
4. [ ] 若涉及嚴重違法，通知負責人

## 情境 B：收到法律文件
1. [ ] **不要自行處理**
2. [ ] 拍照或掃描法律文件
3. [ ] 立即通知公司負責人/法務
4. [ ] 記錄收到時間與文件編號

## 情境 C：大量洗版攻擊
1. [ ] 確認攻擊者 IP Hash
2. [ ] 使用「批量刪除」功能
3. [ ] 記錄攻擊時間與處理方式
4. [ ] 觀察是否持續，必要時調整限流

## 情境 D：資料庫疑似被入侵
1. [ ] **立即停止服務**
2. [ ] 通知技術負責人
3. [ ] 保留所有日誌
4. [ ] 等待資安人員指示
```

---

### 🔧 技術面（最小實作）

#### **必須立即實作（P0）**

1. **Moderation Logs 表**（15 分鐘）
   - 記錄所有管理操作
   - 可追蹤誰在何時做了什麼

2. **使用者條款頁面**（30 分鐘）
   - `/terms.html`
   - 首頁加上「使用即表示同意條款」

#### **營運穩定後實作（P1，30 天內）**

3. **IP/UA 定期清理**（1 小時）
   - Cron job 每週執行
   - 刪除 90 天前的 `real_ip` 和 `user_agent`

4. **管理後台查詢介面**（2 小時）
   - 可查詢特定 Post ID 的 IP
   - 可查詢 moderation logs
   - 不需要複雜 UI，簡單 API endpoint 即可

#### **可選（P2，3 個月後）**

5. **管理員白名單表**（取代環境變數）
6. **硬刪除功能**（緊急情況使用）
7. **限流狀態持久化**（若有洗版問題）

---

## 五、總結與建議優先級

### 🚨 立即修正（上線前）

| 項目 | 工作量 | 風險等級 |
|------|--------|---------|
| 實作 moderation_logs 表 | 15 分鐘 | 高 |
| 新增使用者條款頁面 | 30 分鐘 | 高 |
| 制定管理員操作指引 | 1 小時 | 中 |

### ⏰ 30 天內完成

| 項目 | 工作量 | 風險等級 |
|------|--------|---------|
| IP/UA 定期清理腳本 | 1 小時 | 中高 |
| 簡易管理後台查詢 API | 2 小時 | 中 |
| 制定事件回應 SOP | 1 小時 | 中 |

### 📊 持續監控

- 每月執行安全稽核清單
- 觀察是否有洗版/濫用行為
- 3 個月後評估是否需要升級限流機制

---

## 六、給老闆／法務的一句話

> **「這個平台不會死得漂亮，但可以活得久。」**

我們做到了：
- ✅ 有合理的內容管理機制
- ✅ 可配合法律調查
- ✅ 有明確的版規與免責聲明
- ✅ 管理行為可追蹤（實作 audit log 後）

我們不做：
- ❌ 不做事前審查（這是 UGC 平台的本質）
- ❌ 不保證即時發現違規內容
- ❌ 不承擔使用者發文的法律責任

**關鍵風險控管點**：
1. **立即實作 audit log**（證明我們有管理）
2. **加上使用者條款**（劃清責任邊界）
3. **建立事件回應 SOP**（發生事情時不慌）

---

## 七、附錄：快速實作檢查表

### Phase 0：上線前（必須完成）

- [ ] 建立 `moderation_logs` 表
- [ ] 修改 `deletePost`, `lockPost`, `unlockPost`, `deletePostsByIpHash` 函數，寫入 audit log
- [ ] 建立 `/terms.html` 頁面
- [ ] 在首頁加上「使用即表示同意[使用條款](/terms.html)」
- [ ] 建立內部「管理員操作指引」文件
- [ ] 建立「緊急事件回應 Runbook」文件

### Phase 1：30 天內（營運穩定後）

- [ ] 實作 IP/UA 定期清理腳本
- [ ] 設定 cron job 每週執行清理
- [ ] 建立管理後台查詢 API
  - `GET /admin/posts/:id/details`（查詢 IP）
  - `GET /admin/logs?limit=100`（查詢操作記錄）
- [ ] 制定「每月安全稽核清單」並執行第一次稽核

### Phase 2：3 個月後（可選）

- [ ] 評估是否需要 `admin_whitelist` 表
- [ ] 實作硬刪除功能（預先準備）
- [ ] 觀察洗版情況，決定是否需要 Redis 限流

---

**報告提交者**：內部資安負責人
**審閱建議**：技術主管、法務、營運負責人
**文件版本**：v1.0
**最後更新**：2026-01-13
